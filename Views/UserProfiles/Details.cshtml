@model UserProfile

@{
    ViewData["Title"] = "Детайли";
    string dash(string? s) => string.IsNullOrWhiteSpace(s) ? "-" : s;

    // BMI
    double? heightM = Model.HeightCm > 0 ? Model.HeightCm / 100.0 : null;
    double? bmi = null;
    if (heightM.HasValue && Model.CurrentWeightKg > 0)
    {
        var raw = Model.CurrentWeightKg / (heightM.Value * heightM.Value);
        bmi = Math.Round(raw, 1);
    }

    // BMR (Mifflin–St Jeor) on current weight
    int? bmr = null;
    if (Model.CurrentWeightKg > 0 && Model.HeightCm > 0 && Model.Age > 0)
    {
        var baseVal = 10 * Model.CurrentWeightKg + 6.25 * Model.HeightCm - 5 * Model.Age;
        if (Model.Gender == "Male") bmr = (int)Math.Round(baseVal + 5);
        else if (Model.Gender == "Female") bmr = (int)Math.Round(baseVal - 161);
        else bmr = (int)Math.Round(baseVal);
    }

    double activityFactor = Model.ActivityLevel switch
    {
        "Low" => 1.2,
        "Medium" => 1.55,
        "High" => 1.725,
        _ => 1.2
    };

    int? tdee = bmr.HasValue ? (int)Math.Round(bmr.Value * activityFactor) : null;

    // Activity badge
    string activityText = Model.ActivityLevel switch
    {
        "Low" => "Ниска активност",
        "Medium" => "Средна активност",
        "High" => "Висока активност",
        _ => "-"
    };

    string activityBadge = Model.ActivityLevel switch
    {
        "Low" => "bg-secondary",
        "Medium" => "bg-success",
        "High" => "bg-danger",
        _ => "bg-secondary"
    };

    // Progress
    double? diff = null;
    double? diffPct = null;

    if (Model.StartWeightKg > 0 && Model.CurrentWeightKg > 0)
    {
        diff = Math.Round(Model.CurrentWeightKg - Model.StartWeightKg, 1);
        diffPct = Math.Round(((Model.CurrentWeightKg - Model.StartWeightKg) / Model.StartWeightKg) * 100, 1);
    }

    string progressText = diff.HasValue
        ? (diff.Value > 0 ? $"+{diff:0.0} кг ({diffPct:0.0}%)" : $"{diff:0.0} кг ({diffPct:0.0}%)")
        : "-";

    string progressBadge = diff.HasValue
        ? (diff.Value < 0 ? "bg-success" : diff.Value > 0 ? "bg-danger" : "bg-secondary")
        : "bg-secondary";
}

<h1>@ViewData["Title"]</h1>

<div class="card mb-3">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Име</dt>
            <dd class="col-sm-9">@dash(Model.Name)</dd>

            <dt class="col-sm-3">Години</dt>
            <dd class="col-sm-9">@Model.Age</dd>

            <dt class="col-sm-3">Пол</dt>
            <dd class="col-sm-9">
                @(Model.Gender == "Male" ? "Мъж" :
                                Model.Gender == "Female" ? "Жена" :
                                dash(Model.Gender))
            </dd>

            <dt class="col-sm-3">Стартови килограми</dt>
            <dd class="col-sm-9">@($"{Model.StartWeightKg:0.##} кг")</dd>

            <dt class="col-sm-3">Текущи килограми</dt>
            <dd class="col-sm-9">@($"{Model.CurrentWeightKg:0.##} кг")</dd>

            <dt class="col-sm-3">Височина</dt>
            <dd class="col-sm-9">@($"{Model.HeightCm} см")</dd>

            <dt class="col-sm-3">Активност</dt>
            <dd class="col-sm-9"><span class="badge @activityBadge">@activityText</span></dd>
        </dl>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title mb-3">Метрики</h5>

        <dl class="row mb-0">
            <dt class="col-sm-4">Прогрес спрямо старт</dt>
            <dd class="col-sm-8"><span class="badge @progressBadge">@progressText</span></dd>

            <dt class="col-sm-4">BMI</dt>
            <dd class="col-sm-8">@(bmi?.ToString("0.0") ?? "-")</dd>

            <dt class="col-sm-4">BMR (ккал/ден)</dt>
            <dd class="col-sm-8">@(bmr?.ToString() ?? "-")</dd>

            <dt class="col-sm-4">Дневни калории (TDEE)</dt>
            <dd class="col-sm-8">@(tdee?.ToString() ?? "-")</dd>
        </dl>

        <small class="text-muted">
            TDEE = BMR × фактор на активност (@activityFactor).
        </small>
    </div>
</div>

<p class="mt-3">
    <a class="btn btn-primary" asp-action="Edit">Редакция</a>
    <a class="btn btn-danger" asp-action="Delete">Изтриване</a>
    <a class="btn btn-secondary" asp-action="Index">Назад</a>
</p>
